\documentclass{article}\usepackage[]{graphicx}\usepackage[]{color}
%% maxwidth is the original width if it is less than linewidth
%% otherwise use linewidth (to make sure the graphics do not exceed the margin)
\makeatletter
\def\maxwidth{ %
  \ifdim\Gin@nat@width>\linewidth
    \linewidth
  \else
    \Gin@nat@width
  \fi
}
\makeatother

\definecolor{fgcolor}{rgb}{0.345, 0.345, 0.345}
\newcommand{\hlnum}[1]{\textcolor[rgb]{0.686,0.059,0.569}{#1}}%
\newcommand{\hlstr}[1]{\textcolor[rgb]{0.192,0.494,0.8}{#1}}%
\newcommand{\hlcom}[1]{\textcolor[rgb]{0.678,0.584,0.686}{\textit{#1}}}%
\newcommand{\hlopt}[1]{\textcolor[rgb]{0,0,0}{#1}}%
\newcommand{\hlstd}[1]{\textcolor[rgb]{0.345,0.345,0.345}{#1}}%
\newcommand{\hlkwa}[1]{\textcolor[rgb]{0.161,0.373,0.58}{\textbf{#1}}}%
\newcommand{\hlkwb}[1]{\textcolor[rgb]{0.69,0.353,0.396}{#1}}%
\newcommand{\hlkwc}[1]{\textcolor[rgb]{0.333,0.667,0.333}{#1}}%
\newcommand{\hlkwd}[1]{\textcolor[rgb]{0.737,0.353,0.396}{\textbf{#1}}}%

\usepackage{framed}
\makeatletter
\newenvironment{kframe}{%
 \def\at@end@of@kframe{}%
 \ifinner\ifhmode%
  \def\at@end@of@kframe{\end{minipage}}%
  \begin{minipage}{\columnwidth}%
 \fi\fi%
 \def\FrameCommand##1{\hskip\@totalleftmargin \hskip-\fboxsep
 \colorbox{shadecolor}{##1}\hskip-\fboxsep
     % There is no \\@totalrightmargin, so:
     \hskip-\linewidth \hskip-\@totalleftmargin \hskip\columnwidth}%
 \MakeFramed {\advance\hsize-\width
   \@totalleftmargin\z@ \linewidth\hsize
   \@setminipage}}%
 {\par\unskip\endMakeFramed%
 \at@end@of@kframe}
\makeatother

\definecolor{shadecolor}{rgb}{.97, .97, .97}
\definecolor{messagecolor}{rgb}{0, 0, 0}
\definecolor{warningcolor}{rgb}{1, 0, 1}
\definecolor{errorcolor}{rgb}{1, 0, 0}
\newenvironment{knitrout}{}{} % an empty environment to be redefined in TeX

\usepackage{alltt}
\usepackage{geometry}
\usepackage{amsmath}
\usepackage{lscape}
\geometry{verbose,tmargin=2.5cm,bmargin=2.5cm,lmargin=2.5cm,rmargin=2.5cm}
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\begin{document}




\title{Messina Experiment 2: Messina vs Classical on APGI}
\maketitle


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% LIBRARIES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Preparation}
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{library}\hlstd{(messina)}
\end{alltt}


{\ttfamily\noindent\itshape\color{messagecolor}{\#\# Loading required package: survival\\\#\# Loading required package: splines\\\#\# Loading required package: methods}}\begin{alltt}
\hlkwd{library}\hlstd{(plyr)}
\hlkwd{library}\hlstd{(reshape2)}
\hlkwd{library}\hlstd{(ggplot2)}
\end{alltt}
\end{kframe}
\end{knitrout}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% DATA
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Data preparation}
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{load}\hlstd{(}\hlstr{"../biosurv/data/07_data_for_SIS.rda"}\hlstd{)}
\hlstd{x} \hlkwb{=} \hlstd{x.diag_dsd}
\hlstd{y} \hlkwb{=} \hlstd{y.diag_dsd}
\hlstd{samps} \hlkwb{=} \hlstd{samps.diag_dsd}

\hlstd{temp} \hlkwb{=} \hlnum{NA}
\hlstd{temp} \hlkwb{=} \hlkwd{ls}\hlstd{()}
\hlkwd{rm}\hlstd{(}\hlkwc{list} \hlstd{= temp[}\hlopt{!}\hlstd{(temp} \hlopt{%in%} \hlkwd{c}\hlstd{(}\hlstr{"x"}\hlstd{,} \hlstr{"y"}\hlstd{,} \hlstr{"samps"}\hlstd{))])}
\end{alltt}
\end{kframe}
\end{knitrout}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% FUNCTIONS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Detectors}
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{# For ncuts = 1, this equates to median cut.}
\hlstd{detector_multicut} \hlkwb{=} \hlkwa{function}\hlstd{(}\hlkwc{x}\hlstd{,} \hlkwc{y}\hlstd{,} \hlkwc{ncuts} \hlstd{=} \hlnum{10}\hlstd{,} \hlkwc{correct} \hlstd{=} \hlstr{"none"}\hlstd{)}
\hlstd{\{}
        \hlkwa{if} \hlstd{(ncuts} \hlopt{==} \hlnum{1}\hlstd{) \{ correct} \hlkwb{=} \hlstr{"none"} \hlstd{\}}
        \hlkwd{aaply}\hlstd{(x,} \hlnum{1}\hlstd{,} \hlkwa{function}\hlstd{(}\hlkwc{x1}\hlstd{) \{}
                \hlstd{cutpoints} \hlkwb{=} \hlkwd{quantile}\hlstd{(x1,} \hlkwc{probs} \hlstd{= (}\hlnum{1}\hlopt{:}\hlstd{ncuts)}\hlopt{/}\hlstd{(ncuts} \hlopt{+} \hlnum{1}\hlstd{))}
                \hlstd{pvals} \hlkwb{=} \hlkwd{sapply}\hlstd{(cutpoints,} \hlkwa{function}\hlstd{(}\hlkwc{c}\hlstd{) \{}
                        \hlstd{x1c} \hlkwb{=} \hlstd{x1} \hlopt{>} \hlstd{c}
                        \hlstd{test} \hlkwb{=} \hlkwd{survdiff}\hlstd{(y} \hlopt{~} \hlstd{x1c)}
                        \hlstd{pval} \hlkwb{=} \hlkwd{pchisq}\hlstd{(test}\hlopt{$}\hlstd{chisq,} \hlkwc{df} \hlstd{=} \hlnum{1}\hlstd{,} \hlkwc{lower.tail} \hlstd{=} \hlnum{FALSE}\hlstd{)}
                        \hlstd{pval}
                \hlstd{\})}
                \hlstd{pvals} \hlkwb{=} \hlkwd{p.adjust}\hlstd{(pvals, correct)}
                \hlstd{pvals[}\hlkwd{is.na}\hlstd{(pvals)]} \hlkwb{=} \hlnum{1}
                \hlkwd{c}\hlstd{(}\hlkwd{min}\hlstd{(pvals), cutpoints[}\hlkwd{which.min}\hlstd{(pvals)])}
        \hlstd{\},} \hlkwc{.parallel} \hlstd{=} \hlnum{TRUE}\hlstd{)}
\hlstd{\}}


\hlcom{# A 'best-approach' to all-cutoff testing}
\hlstd{detector_maxstat} \hlkwb{=} \hlkwa{function}\hlstd{(}\hlkwc{x}\hlstd{,} \hlkwc{y}\hlstd{,} \hlkwc{pmethod} \hlstd{=} \hlstr{"HL"}\hlstd{)}
\hlstd{\{}
        \hlkwd{require}\hlstd{(maxstat)}

        \hlkwd{aaply}\hlstd{(x,} \hlnum{1}\hlstd{,} \hlkwa{function}\hlstd{(}\hlkwc{x1}\hlstd{) \{}
                \hlstd{temp.data} \hlkwb{=} \hlkwd{data.frame}\hlstd{(}\hlkwc{x1} \hlstd{= x1,} \hlkwc{time} \hlstd{= y[,}\hlnum{1}\hlstd{],} \hlkwc{event} \hlstd{= y[,}\hlnum{2}\hlstd{])}
                \hlstd{test} \hlkwb{=} \hlkwd{try}\hlstd{(}\hlkwd{maxstat.test}\hlstd{(}\hlkwd{Surv}\hlstd{(time, event)} \hlopt{~} \hlstd{x1,} \hlkwc{data} \hlstd{= temp.data,} \hlkwc{smethod} \hlstd{=} \hlstr{"LogRank"}\hlstd{,} \hlkwc{pmethod} \hlstd{= pmethod))}
                \hlkwa{if} \hlstd{(}\hlkwd{class}\hlstd{(test)} \hlopt{==} \hlstr{"try-error"}\hlstd{)}
                \hlstd{\{}
                        \hlkwd{return}\hlstd{(}\hlnum{NA}\hlstd{,} \hlnum{NA}\hlstd{)}
                \hlstd{\}}
                \hlkwd{c}\hlstd{(test}\hlopt{$}\hlstd{p.value, test}\hlopt{$}\hlstd{estimate)}
        \hlstd{\},} \hlkwc{.parallel} \hlstd{=} \hlnum{TRUE}\hlstd{)}
\hlstd{\}}
\end{alltt}
\end{kframe}
\end{knitrout}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% EXPERIMENT 2
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{The Experiment}
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{library}\hlstd{(doMC)}
\end{alltt}


{\ttfamily\noindent\itshape\color{messagecolor}{\#\# Loading required package: foreach\\\#\# Loading required package: iterators\\\#\# Loading required package: parallel}}\begin{alltt}
\hlkwd{registerDoMC}\hlstd{(}\hlnum{32}\hlstd{)}

\hlstd{fit.messina} \hlkwb{=} \hlkwd{messinaSurv}\hlstd{(x, y,} \hlkwd{messinaSurvObj.CoxCoef}\hlstd{(}\hlkwd{log}\hlstd{(}\hlnum{2}\hlstd{)),} \hlkwc{parallel} \hlstd{=} \hlnum{TRUE}\hlstd{)}
\end{alltt}


{\ttfamily\noindent\itshape\color{messagecolor}{\#\# Performance bootstrapping...\\\#\# Final training...}}\begin{alltt}
\hlstd{fit.medcut} \hlkwb{=} \hlkwd{detector_multicut}\hlstd{(x, y,} \hlkwc{ncuts} \hlstd{=} \hlnum{1}\hlstd{)}
\hlstd{fit.10cutHolm} \hlkwb{=} \hlkwd{detector_multicut}\hlstd{(x, y,} \hlkwc{ncuts} \hlstd{=} \hlnum{10}\hlstd{,} \hlkwc{correct} \hlstd{=} \hlstr{"holm"}\hlstd{)}
\hlstd{fit.maxstat} \hlkwb{=} \hlkwd{detector_maxstat}\hlstd{(x, y)}
\end{alltt}


{\ttfamily\noindent\itshape\color{messagecolor}{\#\# Loading required package: maxstat}}\begin{alltt}
\hlstd{det.messina} \hlkwb{=} \hlstd{fit.messina}\hlopt{@}\hlkwc{fits}\hlopt{@}\hlkwc{summary}\hlopt{$}\hlstd{passed}
\hlstd{det.medcut} \hlkwb{=} \hlstd{fit.medcut[,}\hlnum{1}\hlstd{]} \hlopt{<} \hlnum{0.05} \hlopt{& !}\hlkwd{is.na}\hlstd{(fit.medcut[,}\hlnum{1}\hlstd{])}
\hlstd{det.10cutHolm} \hlkwb{=} \hlstd{fit.10cutHolm[,}\hlnum{1}\hlstd{]} \hlopt{<} \hlnum{0.05} \hlopt{& !}\hlkwd{is.na}\hlstd{(fit.medcut[,}\hlnum{1}\hlstd{])}
\hlstd{det.maxstat} \hlkwb{=} \hlstd{fit.maxstat[,}\hlnum{1}\hlstd{]} \hlopt{<} \hlnum{0.05} \hlopt{& !}\hlkwd{is.na}\hlstd{(fit.medcut[,}\hlnum{1}\hlstd{])}

\hlstd{thresh.messina} \hlkwb{=} \hlstd{fit.messina}\hlopt{@}\hlkwc{fits}\hlopt{@}\hlkwc{summary}\hlopt{$}\hlstd{threshold}
\hlstd{thresh.medcut} \hlkwb{=} \hlstd{fit.medcut[,}\hlnum{2}\hlstd{]}
\hlstd{thresh.10cutHolm} \hlkwb{=} \hlstd{fit.10cutHolm[,}\hlnum{2}\hlstd{]}
\hlstd{thresh.maxstat} \hlkwb{=} \hlstd{fit.maxstat[,}\hlnum{2}\hlstd{]}

\hlstd{thresh.messina[det.messina} \hlopt{==} \hlnum{FALSE}\hlstd{]} \hlkwb{=} \hlnum{NA}
\hlstd{thresh.medcut[det.medcut} \hlopt{==} \hlnum{FALSE}\hlstd{]} \hlkwb{=} \hlnum{NA}
\hlstd{thresh.10cutHolm[det.10cutHolm} \hlopt{==} \hlnum{FALSE}\hlstd{]} \hlkwb{=} \hlnum{NA}
\hlstd{thresh.maxstat[det.maxstat} \hlopt{==} \hlnum{FALSE}\hlstd{]} \hlkwb{=} \hlnum{NA}
\end{alltt}
\end{kframe}
\end{knitrout}

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{load}\hlstd{(}\hlstr{"../biosurv/data/15_validation.rda"}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{save.image}\hlstd{(}\hlstr{"03_surv_exp2.rda"}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}

\end{document}
